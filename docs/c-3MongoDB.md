------

# MongoDB

> 作者：hou

## 1.1 MongoDB存储结构

### 1.1.1 基本存储结构

1. **文档（Document）**  
- MongoDB 中最基本的单元，由 BSON 键值对（key-value）组成，类似于关系型数据库中的行（Row）  

2. **集合（Collection）**  
- 一个集合可以包含多个文档，类似于关系型数据库中的表（Table）  

3. **数据库（Database）**  
- 一个数据库中可以包含多个集合，可以在 MongoDB 中创建多个数据库，类似于关系型数据库中的数据库（Database）  

## 1.2 MongoDB存储引擎

### 1.2.极短1 存储引擎类型

1. **WiredTiger**  
- 使用 B+ 树作为底层数据结构，支持高效的读写操作和压缩存储  

2. **In-Memory**  
- 数据完全存储在内存中，适合对性能要求极高的场景  

## 1.3 MongoDB聚合

### 1.3.1 聚合操作

1. **聚合管道**  
- 通过多个阶段（stage）对数据进行处理和转换，支持复杂的聚合操作  

2. **单一目的聚合方法**  
- 提供了一些简单的聚合方法，如 `count`、`distinct` 等  

## 1.4 MongoDB加字段操作

### 1.4.1 加字段是否会锁表

1. **MySQL的InnoDB**  
- 默认情况下会锁表，可以使用 `algorithm=Inplace`、`instant` 来避免锁表  

2. **MongoDB**  
- 无模式设计，添加字段通常不锁表  
  - **insert**：不锁表  
  - **update**：更新现有文档，锁单个文档  
  - **修改集合选项**：短暂锁集合

## 1.5 MongoDB索引

### 1.5.1 索引类型

1. **单字段索引**  
- 在单个字段上创建的索引  

2. **复合索引**  
- 在多个字段上创建的索引，支持多字段查询优化  

3. **多键索引**  
- 在数组字段上创建的索引，支持数组元素的查询  

4. **文本索引**  
- 支持全文搜索的索引  

5. **地理空间索引**  
- 支持地理空间查询的索引  

## 1.7 MongoDB分片

### 1.7.1 分片概念

1. **分片键**  
- 用于将数据分布到不同分片上的字段  

2. **分片策略**  
- 根据分片键选择合适的分片策略，如范围分片、哈希分片等  

### 1.7.2 分片优化

1. **分片键选择**  
- 选择高基数字段作为分片键，确保数据均匀分布  

2. **分片维护**  
- 定期检查和优化分片，避免数据倾斜  

## 1.8 MongoDB备份与恢复

### 1.8.1 备份策略

1. **mongodump**  
- 使用 `mongodump` 工具进行数据备份  

2. **文件系统快照**  
- 使用文件系统快照进行数据备份  

### 1.8.2 恢复策略

1. **mongorestore**  
- 使用 `mongorestore` 工具进行数据恢复  

2. **文件系统恢复**  
- 使用文件系统快照进行数据恢复