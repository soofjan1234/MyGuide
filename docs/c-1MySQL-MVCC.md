------

# MVCC

> 作者：hou

# 1.1 什么是MVCC

MVCC（Multi-Version Concurrency Control）是一种并发控制机制，用于在数据库管理系统中管理多个事务的并发访问。它通过为每个事务分配一个唯一的版本号（Snapshot），来实现对数据的并发读取和写入，从而避免了锁的开销。

# 1.2 相关概念

## 1.2.1 事务版本号

事务每次开启时，都会从数据库获得一个自增长的事务ID，可以从事务ID判断事务的执行先后顺序。这就是事务版本号。

## 1.2.2 隐藏列

在数据库表中，有两个隐藏列：

- trx_id：表示当前事务的ID。
- roll_pointer：指向当前事务的回滚记录。
- row_id：表示当前行的ID。(非必须)

## 1.2.3 undo log

undo log 是一种用于事务回滚的日志，它记录了事务对数据库的修改操作。当事务执行失败时，undo log 可以用来撤销已经执行的操作，从而保证数据库的一致性。

## 1.2.4 版本链

多个事务并行操作某一行数据时，不同事务对该行数据的修改会产生多个版本，然后通过回滚指针（roll_pointer），连成一个链表，这个链表就称为版本链

## 1.2.5 快照读和当前读

快照读：读取的是事务开始前的数据库状态，即事务开始时的快照。

当前读：读取的是事务开始后的数据库状态，即事务执行过程中对数据库的修改。

## 1.2.6 ReadView

ReadView 是 MVCC 的核心，它用于管理事务的可见性。

- trx_ids: 当前系统中那些活跃(未提交)的读写事务ID, 它数据结构为一个List。(重点注意:这里的trx_ids中的活跃事务，不包括当前事务自己和已提交的事务，这点非常重要)

- low_limit_id: 目前出现过的最大的事务ID+1，即下一个将被分配的事务ID。

- up_limit_id: 活跃事务列表trx_ids中最小的事务ID，如果trx_ids为空，则up_limit_id 为 low_limit_id。

- creator_trx_id: 表示生成该 ReadView 的事务的 事务id