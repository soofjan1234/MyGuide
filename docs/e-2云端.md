------

# 云端

> 作者：hou
------

## 1.1  穿透交互架构

1. **客户端请求穿透**  
   - 服务端验证管理员身份，向云端请求 `peerID`、`peerPwd`、`accessID` 和 `accessVerify`
      - peerID和peerPwd用于服务端开启穿透
      - accessID用于客户端向云端获取穿透信息
      - accessVerify用于客户端与服务端握手连接  

2. **服务端开启穿透**  
   - 服务端根据 `peer` 账号密码向穿透端开启穿透，配置隧道参数并启动隧道。  

3. **客户端获取信息**  
   - 客户端通过服务端得到 `accessID`，向云端请求得到 `peerID`、`accessVerify`  

4. **客户端开启穿透**  
   - 客户端根据 `peer` 账号向穿透端开启穿透  

5. **握手连接**  
   - 客户端与服务端进行握手连接，校验 `accessVerify`  

## 1.2  AES+RSA 混合加密

### 1.3.1. 对称加密

使用相同的密钥进行加密和解密，常见的算法包括 AES和 DES。

优点：
- 速度快，计算效率高

缺点：
- 密钥管理困难：所有通信方必须共享同一密钥。密钥的传输和管理非常重要，因为如果密钥被泄露，整个系统的安全性就会受到威胁。

### 1.3.2. 非对称加密

使用一对密钥（公钥和私钥）进行加密和解密，常见的算法包括 RSA和 ECC。

优点：
- 密钥交换安全：公钥可以公开，私钥始终保密。即使攻击者获取了公钥，也无法解密数据。
- 适用于身份验证：可以用私钥加密信息，接收方用公钥解密，从而验证消息的发送者身份。
- 无需密钥共享：避免了对称加密中密钥传输的安全风险。

缺点：
- 速度较慢，计算复杂度高：由于RSA等非对称加密的数学复杂性，性能较差。

### 1.3.3 哈希算法

哈希算法用于生成数据的唯一固定长度“指纹”，通常用于数据完整性验证。常见算法有 SHA-256。

优点：
- 速度快：哈希算法处理速度非常快，适合大量数据的验证。
- 不可逆：哈希值无法逆向推导回原始数据，有助于保护数据隐私。
- 防篡改：通过对数据生成哈希值，能够确保数据在传输过程中未被篡改。

缺点：
- 无法解密数据：哈希算法不能加密或解密数据，只能用于验证数据完整性，不能用于保密通信。

### 1.3.4 数字签名

数字签名结合了非对称加密和哈希算法，通常用于验证数据的来源和完整性。

优点：
- 身份验证：数字签名可以验证消息的来源，确保数据确实来自预期的发送者。
- 数据完整性：数字签名可以确保数据在传输过程中没有被篡改。
- 合法性：在法律上，数字签名具有一定的合法效力，广泛应用于合同签署和电子支付等场景。

缺点：
- 性能较差：数字签名涉及哈希和非对称加密的计算，速度比直接的对称加密慢。
- 只验证数据完整性和身份：它不提供加密，无法保护数据的机密性。

### 1.3.5 混合加密

混合加密结合了对称加密和非对称加密的优点，通常用于保护数据的机密性和完整性。

优点：
1. 加密速度和效率：
- AES 是对称加密算法，加密速度快。因此，使用AES来加密实际的数据部分很高效。
- RSA 是非对称加密算法，虽然加密数据时较慢，但非常适合交换加密用的对称密钥（如AES密钥）。RSA仅用于加密和传输小的密钥，而不是整个数据。

2. 密钥交换的安全性：
- 使用 RSA 交换 AES 的密钥。因为非对称加密提供了安全的密钥交换机制，确保AES密钥可以安全地传输，即使是在不安全的网络环境中。
- 通过 RSA 加密 AES 密钥，只有拥有私钥的一方才能解密密钥，从而确保通信安全。

### 1.3.6 加密步骤

1. **生成密钥**：客户端生成 AES 的 `key` 和 `nonce`  

2. **加密数据**：客户端用 AES 加密 `data`  

3. **加密密钥**：客户端用 RSA 公钥加密 AES 的 `key`  

4. **解密密钥**：服务端拿 RSA 私钥解密 `key`  

5. **还原数据**：然后还原 `data`  

## 2.1 代码
### 2.1.1. lincaccessbackend
主要负责实现远程访问和隧道连接功能

1. 核心功能
远程访问：通过 P2P 隧道技术实现设备的远程访问，允许用户从外部网络访问本地设备。
隧道管理：负责隧道的创建、连接、断开等操作，确保数据传输的安全性和稳定性。
网络状态监控：监听设备的网络状态变化，自动调整隧道连接策略。
后台服务：通过 HostService 实现后台运行，确保隧道连接的持续性和可靠性。

2. 主要类与文件
HostService.kt：后台服务类，负责隧道连接的启动、停止和状态管理。
KtorHost.kt：基于 Ktor 框架的网络服务，处理隧道连接的 HTTP 请求和响应。
PGTunnelServiceImpl.kt：隧道服务的具体实现，封装了隧道连接的核心逻辑。
BootReceiver.java：系统启动时自动启动隧道服务的广播接收器。
AppCtx.java：应用上下文类，初始化隧道服务

## 3.1 问题

#### 1. 穿透的设备之间怎么通信？
- 直接连接（P2P） ：
   - 如果 NAT 允许，设备之间通过 STUN 获取的公网地址直接通信。
   - 数据通过加密隧道传输，确保安全性。
- 中继连接（TURN） ：
   - 如果 NAT 不允许直接连接，设备通过 TURN 服务器中继数据。
   - TURN 服务器将数据转发给目标设备，确保通信的可靠性。
- 混合模式（ICE） ：
   - 结合 STUN 和 TURN，自动选择最佳连接方式。
   - 优先使用直接连接，失败时使用中继连接

 #### 2. p2p通信是什么？
P2P（Peer-to-Peer）通信是一种 去中心化 的通信模型，其中每个节点（peer）既可以是客户端，也可以是服务器。这与传统的客户端-服务器（Client-Server）模型不同，后者所有客户端请求都通过一个中心服务器。

 #### 3. 提到的“穿透”指的是什么？讲讲 NAT、STUN、TURN

1. **穿透原理**  
   - 打洞过程 ：
   1. 发现公网地址 ：通过 STUN 服务器，设备获取自己的公网 IP 和端口。
   2. 交换地址信息 ：设备通过公网服务器（如信令服务器）交换彼此的公网地址信息。
   3. 尝试直接连接 ：设备尝试使用对方的公网地址建立直接连接。
   4. 穿透 NAT ：如果 NAT 允许，设备之间可以直接通信；否则，需要使用 TURN 服务器中继数据。  

2. **NAT**  
   - 私有 IP 地址：这些地址在局域网（LAN）内使用，不会在互联网上直接路由
   - 允许多个设备共享一个公共 IP 地址以访问互联网  
   - 设备位于 NAT 后时，无法直接从外部访问，因为 NAT 会隐藏设备的真实 IP 地址。

3. **STUN**  
   - 允许 NAT 后的设备发现其公共 IP 地址和端口。当两个设备都知道对方的公共 IP 和端口时，它们就可以尝试建立 P2P 连接。  

4. **TURN**  
   - 数据中转站
   1. 设备注册 ：设备向 TURN 服务器注册，并获取一个中继地址（公网 IP 和端口）。
   2. 数据转发 ：设备将数据发送到 TURN 服务器，TURN 服务器将数据转发给目标设备。
   3. 通信建立 ：设备通过 TURN 服务器进行双向通信，确保数据能够到达对方。

#### 4. NAT 类型
- 全锥型（Full Cone）：
   - 所有从同一内网 IP 和端口发出的请求都映射成同一公网 IP 和端口
   - 任何外部主机都可通过这个 IP:Port 与内网通信
- 受限锥型（Restricted Cone）：
   - 只有内网发过请求的外部 IP 才能响应
- 端口受限锥型（Port Restricted Cone）：
   - 只有内网发过请求的外部 IP:Port 才能响应
- 对称型（Symmetric）：
   - 内网向不同外部 IP/Port 发请求时，会为每个映射一个新的公网 IP:Port；
   - 且只能收到特定目标的返回

#### 你的这个过程中，怎么就得到公网ip地址和端口呢？
#### 什么时候做的打洞，怎么打的洞？
tcp协议
nas节点先和服务器建立连接，相当有洞了
客服端向服务器

#### 中国网络环境复杂，你这个成功率多少，有对nat类型的要求吗？
#### 局域网内连接的流程
1. nas通过网线连接路由器
2. 手机连接路由器的wifi
3. 手机nas-app扫描该路由器下的ip地址，使用socket连接特定端口（Socket 通常基于 TCP 或 UDP 协议
4. 得到ip地址，点击连接或可通过网页访问

讲讲socket
穿透 相当于也是通过ip来访问的是吧
#### p2p是发http请求的吗
很多 P2P 网络使用自定义的协议或者基于 UDP、TCP 等传输层协议直接构建通信机制，而不依赖 HTTP 协议
即使使用了 NAT 穿透和 P2P 技术，手机依然可以通过发送 HTTP 请求来访问 NAS 上的 HTTP 服务

#### 网络带宽
1. 优化p2p：
   - 选择合适的连接方式，优先stun，不行再turn
   - 动态调整，stun带宽不足，可尝试切换turn
2. 带宽管理与优化
   - 在设备端设置合理的数据传输速率限制，避免某个设备占用过多带宽，影响其他设备的正常使用
   - 数据压缩与优化 ：在传输数据前对其进行压缩，减少数据量
3. 内容分发优化
   - CDN
   - p2p内容分发

