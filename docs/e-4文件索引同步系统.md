------
# 文件索引系统

> 作者：hou
------

## 1.1 模块化解耦

将核心功能抽离为独立的服务模块，提供标准化接口供其他项目调用。

### 1.1.1 why
这个文件同步的功能，许多模块都要使用到：网盘、相册、音乐和视频等。

为了提高代码的可维护性和可扩展性，我们将文件同步功能独立为一个服务模块

### 1.1.2 how
1. 客户端传入DB，相关Dao层函数，自定义函数
2. 服务端接受函数，挨个赋值

比如相册端使用 `GetFileInfoFromFS()` 获取文件信息，只关心是否是图片文件，不关心其他信息。

## 2.1 算法实现
初期基于 fsnotify 快速开发，后期自研 DFS+Queue 架构。

### 2.1.1 why
最初我采用 **fsnotify** 实现文件索引功能，但该方案存在明显局限性：
- 无法监控子目录变更
- 跨平台行为不一致
- 会遗漏部分文件系统事件
尝试修改无果后，最终**重构了文件索引同步系统**

### 2.1.2 how
1. 用户提交根目录同步任务
2. 任务被记录到数据库，然后放入队列
3. 主循环从队列中取出任务
4. 处理当前目录：
  - 获取所有子文件和子目录
  - 对每个子目录提交新任务（DFS）
  - 同步每个子文件
5. 新提交的子目录任务会被放入队列，等待后续处理
6. 重复3-5直到所有任务处理完毕