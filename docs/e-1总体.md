------

# 总体

> 作者：hou

## 1.1 nas

### 1.1.1 nas是什么东西

NAS 就是接在局域网上的“共享硬盘”。它让多台设备（电脑、手机等）能随时存取文件，像自己电脑里的硬盘一样方便。

1. **家庭使用**  
   - 存储多种类型的文件，可以用多个设备访问  

2. **公司使用**  
   - 存储重要文件，并进行权限管理  

3. **远程访问**  
   - 在外面，如果想访问 NAS 里的文件，也可以通过穿透实现  

### 1.1.2 nas的架构

#### **客户层（Customer Layer）**

- **包含**：Android、iOS、Web、Windows、macOS 客户端  
- **交互方式**：  
  - 直连服务器  
  - 局域网（LAN）转发  
  - 广域网（WAN）隧道穿透  

#### **云服务层（Cloud Layer）**

- 云认证系统（用于穿透服务）  
- 穿透中继服务  
- 官方网站/社区/资源中心  

#### **NAS 系统软件架构（自底向上）**

1. **Linux 操作系统**  
2. **系统服务层**  
   - OTA 升级服务  
   - 磁盘管理服务  
   - 系统配置服务  
3. **核心服务层**  
   - 网盘服务  
   - 用户模块  
4. **应用服务层**  
   - 相册应用  
   - 音乐播放服务  
   - 影视库管理  
   - Docker 容器服务  
5. **网关层（Gateway）**  

### 1.1.3 技术选型

1. **网盘**  
   在研究如何实现云存储系统时，我了解到三种主要技术：WebDAV、MinIO 和 OwnCloud。  
   - **MinIO**：更适合大规模分布式存储，但我们的 NAS 系统规模较小，因此不符合需求。  
   - **OwnCloud**：更侧重协作功能，这也与我们的使用场景不匹配。  
   - **WebDAV**：是最佳选择，因为它基于 HTTP 协议、内置身份验证机制，且开发更便捷  

2. **网关**  
   主要有 Nginx 和 Traefik 两种网关。  
   - **Nginx**：是一个高性能的 HTTP 和反向代理服务器，支持负载均衡、缓存、安全等功能。复杂需求比较麻烦，需要使用 Lua 脚本或其他插件  
   - **Traefik**：是一个开源的边缘路由器，支持动态配置、负载均衡、服务发现等功能，中间件机制（Middleware）让你可以在路由链上自由插入鉴权、限流、重试等逻辑  

### 1.1.4 网盘

1. **如何存几百 GB 的大文件？分片上传、断点续传**  
   - **分片上传**：  
     若请求包含 `Content-Range` 头部，表示该文件是分块上传的，它会解析 `Content-Range`，获取文件的起始字节与结束字节。  
     如果是分块上传，它会：在指定的临时文件路径（`tmpFilePath`）下存储文件，并在上传成功后将文件移动到目标路径（`realFilePath`）。  
   - **断点续传**：  
     - **文件存在检查**：  
       如果 `tmpFilePath` 文件已经存在且其大小与 `Content-Range` 中提供的开始字节（`startByte`）匹配，它会通过 `resumeUpload` 函数继续接收文件数据。  
     - **resumeUpload**：  
       处理了文件的追加写入（如果文件已存在），打开文件并将请求体中的数据续写到文件。  
     - **上传完成**：  
       它会将文件从临时路径 `tmpFilePath` 移动到真实文件路径 `realFilePath`。

2. **如何检测文件损坏并使用备份？**  
   - **备份机制**：定期备份文件，确保数据安全  
   - **检验和**：通过校验和（如 MD5、SHA-1）检测文件是否损坏，若校验和不匹配，则使用备份文件  

3. **减少存储空间占用并抗容灾的算法**  
   - **减少存储空间占用**：  
     - **数据去重**：通过去重算法减少重复数据的存储  
     - **数据压缩**：使用压缩算法（如 Gzip、Zstandard）减少文件大小  
   - **容灾机制**：  
     - **本地副本**：NAS 设备内部会将文件系统中的数据写入多个硬盘或磁盘阵列中，保障即使硬盘出现故障也能保证数据的高可用性。例如，RAID 5、RAID 6 等技术。  
     - **远程副本**：通过远程的 NAS 存储设备或者云存储服务，将数据实时或定时复制到不同的地点。这样，即使数据中心发生故障，另一个地理位置的副本依然能够提供访问。